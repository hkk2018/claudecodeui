name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # ÊØèÈÄ±‰∏ÄÊó©‰∏ä 9 Èªû (UTC) Âü∑Ë°å
    - cron: '0 9 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================================
  # üî¥ ÈóúÈçµÂ±§ÔºöÂøÖÈ†àÈÄöÈÅéÔºåÂê¶ÂâáÈòªÊìã PR merge
  # ============================================================

  # Ê™¢Êü•ÊïèÊÑüË≥áË®äÊ¥©Êºè - üî¥ ÈòªÊìã
  secrets-scan:
    name: "üî¥ Secrets Detection (Blocking)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan (PR only)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog Secret Scan (Push/Schedule)
        if: github.event_name != 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified
        # Ê≤íÊúâ continue-on-errorÔºåÂ§±ÊïóÊúÉÈòªÊìã

  # npm audit È´òÂç±ÊºèÊ¥û - üî¥ ÈòªÊìã
  npm-audit-critical:
    name: "üî¥ NPM Audit Critical (Blocking)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Check for critical vulnerabilities
        run: |
          # Âè™Ê™¢Êü• critical Á≠âÁ¥öÔºåÊúâÂ∞±Â§±Êïó
          npm audit --audit-level=critical
        # Ê≤íÊúâ continue-on-errorÔºåcritical ÊºèÊ¥ûÊúÉÈòªÊìã

  # ============================================================
  # üü° Ë≠¶ÂëäÂ±§ÔºöÈ°ØÁ§∫Ë≠¶ÂëäÔºå‰ΩÜ‰∏çÈòªÊìã PR merge
  # ============================================================

  # CodeQL ÈùúÊÖãÁ®ãÂºèÁ¢ºÂàÜÊûê - üü° Ë≠¶Âëä
  codeql:
    name: "üü° CodeQL Analysis (Warning)"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
        # CodeQL ÁµêÊûúÊúÉÈ°ØÁ§∫Âú® Security tabÔºå‰∏çÈòªÊìã workflow

  # npm audit ÂÆåÊï¥Â†±Âëä - üü° Ë≠¶Âëä
  npm-audit-full:
    name: "üü° NPM Audit Full (Warning)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit (all levels)
        run: npm audit --audit-level=low || true

      - name: Generate audit report
        run: npm audit --json > npm-audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  # ESLint ÂÆâÂÖ®ÊÄßË¶èÂâáÊ™¢Êü• - üü° Ë≠¶Âëä
  eslint-security:
    name: "üü° ESLint Security (Warning)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Install ESLint security plugins
        run: |
          npm install --save-dev eslint @eslint/js eslint-plugin-security eslint-plugin-no-secrets

      - name: Create ESLint security config
        run: |
          cat > eslint.security.config.js << 'EOF'
          import security from 'eslint-plugin-security';
          import noSecrets from 'eslint-plugin-no-secrets';

          export default [
            {
              files: ['**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx'],
              plugins: {
                security,
                'no-secrets': noSecrets,
              },
              rules: {
                // ÂÆâÂÖ®ÊÄßË¶èÂâá
                'security/detect-buffer-noassert': 'error',
                'security/detect-child-process': 'warn',
                'security/detect-disable-mustache-escape': 'error',
                'security/detect-eval-with-expression': 'error',
                'security/detect-no-csrf-before-method-override': 'error',
                'security/detect-non-literal-fs-filename': 'warn',
                'security/detect-non-literal-regexp': 'warn',
                'security/detect-non-literal-require': 'warn',
                'security/detect-object-injection': 'warn',
                'security/detect-possible-timing-attacks': 'warn',
                'security/detect-pseudoRandomBytes': 'error',
                'security/detect-unsafe-regex': 'error',
                // Ê™¢Ê∏¨Á°¨Á∑®Á¢ºÁöÑ secrets
                'no-secrets/no-secrets': ['error', { tolerance: 4.5 }],
              },
            },
          ];
          EOF

      - name: Run ESLint security scan
        run: npx eslint --config eslint.security.config.js src/ server/ --format json --output-file eslint-security-report.json || true

      - name: Display security issues
        run: |
          if [ -f eslint-security-report.json ]; then
            echo "=== ESLint Security Report ==="
            cat eslint-security-report.json | npx -y json -a filePath messages || cat eslint-security-report.json
          fi

      - name: Upload ESLint report
        uses: actions/upload-artifact@v4
        with:
          name: eslint-security-report
          path: eslint-security-report.json
          retention-days: 30

  # OSV ‰æùË≥¥ÊºèÊ¥ûÊéÉÊèè - üü° Ë≠¶Âëä
  osv-scanner:
    name: "üü° OSV Vulnerability Scan (Warning)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --lockfile=package-lock.json
            --format=table
        continue-on-error: true

  # ============================================================
  # üìä ÂÆâÂÖ®ÊÄßÊëòË¶ÅÂ†±Âëä
  # ============================================================
  security-summary:
    name: "üìä Security Summary"
    runs-on: ubuntu-latest
    needs: [secrets-scan, npm-audit-critical, codeql, npm-audit-full, eslint-security, osv-scanner]
    if: always()

    steps:
      - name: Security Scan Summary
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üî¥ Blocking Checks (Must Pass)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "| Secrets Detection | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secrets Detection | ‚ùå **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.npm-audit-critical.result }}" == "success" ]; then
            echo "| NPM Critical Vulnerabilities | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| NPM Critical Vulnerabilities | ‚ùå **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üü° Warning Checks (Informational)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit (All) | ${{ needs.npm-audit-full.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Security | ${{ needs.eslint-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OSV Scanner | ${{ needs.osv-scanner.result }} |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Note**: Only üî¥ Blocking checks will prevent PR merge." >> $GITHUB_STEP_SUMMARY

      - name: Fail if blocking checks failed
        if: needs.secrets-scan.result == 'failure' || needs.npm-audit-critical.result == 'failure'
        run: |
          echo "‚ùå One or more blocking security checks failed!"
          echo ""
          echo "Secrets Detection: ${{ needs.secrets-scan.result }}"
          echo "NPM Critical Audit: ${{ needs.npm-audit-critical.result }}"
          echo ""
          echo "Please fix the issues before merging."
          exit 1
